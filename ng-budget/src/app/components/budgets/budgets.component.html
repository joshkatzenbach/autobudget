<div class="budgets-container">
  <header class="header">
    <div class="header-top">
      <h1>{{ budget()?.name || 'My Budget' }}</h1>
      <div class="header-actions">
        <app-plaid-link></app-plaid-link>
        <button class="btn-primary" (click)="syncTransactions()" [disabled]="syncLoading()">
          {{ syncLoading() ? 'Syncing...' : 'Sync Transactions' }}
        </button>
        <button class="btn-primary" routerLink="/budgets/edit">
          {{ budget() ? 'Edit Budget' : 'Create Budget' }}
        </button>
        <button class="btn-secondary" (click)="logout()">Logout</button>
      </div>
    </div>
    
    <!-- Tab Navigation -->
    <div class="tabs">
      <button 
        class="tab-button" 
        [class.active]="activeTab() === 'summary'"
        (click)="activeTab.set('summary')">
        Summary
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab() === 'transactions'"
        (click)="activeTab.set('transactions')">
        Transactions
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab() === 'analytics'"
        (click)="activeTab.set('analytics')">
        Analytics
      </button>
    </div>
  </header>

  <!-- Tab Content -->
  @if (activeTab() === 'summary') {
    <div class="tab-content summary-tab">
      <!-- Balance Snapshot -->
      @if (balanceSnapshot()) {
        <div class="balance-snapshot">
      <div class="balance-header">
        <h2>Current Balance</h2>
        <button class="btn-refresh" (click)="loadBalanceSnapshot()" [disabled]="balanceLoading()">
          {{ balanceLoading() ? 'Refreshing...' : 'Refresh' }}
        </button>
      </div>
      <div class="balance-summary">
        <div class="balance-item">
          <span class="balance-label">Net Balance:</span>
          <span class="balance-amount" [class.positive]="balanceSnapshot()!.netBalance >= 0" [class.negative]="balanceSnapshot()!.netBalance < 0">
            {{ formatCurrency(balanceSnapshot()!.netBalance) }}
          </span>
        </div>
        <div class="balance-breakdown">
          <div class="breakdown-item">
            <span class="breakdown-label">Total Assets:</span>
            <span class="breakdown-amount positive">{{ formatCurrency(balanceSnapshot()!.totalAssets) }}</span>
          </div>
          <div class="breakdown-item">
            <span class="breakdown-label">Total Debts:</span>
            <span class="breakdown-amount negative">{{ formatCurrency(balanceSnapshot()!.totalDebts) }}</span>
          </div>
        </div>
      </div>

      <!-- Account Breakdown -->
      @if (balanceSnapshot()!.accounts.length > 0) {
        <div class="account-breakdown">
          <!-- Assets Section -->
          @if (getAssetAccounts().length > 0) {
            <div class="account-section">
              <h3 class="section-title">Assets</h3>
              <div class="account-list">
                @for (account of getAssetAccounts(); track account.accountId) {
                  <div class="account-row asset">
                    <div class="account-info">
                      @if (editingAccountId() === account.accountId) {
                        <div class="account-name-edit">
                          <input 
                            type="text" 
                            [(ngModel)]="editingAccountName"
                            (keyup.enter)="saveAccountName(account.accountId)"
                            (keyup.escape)="cancelEditingAccountName()"
                            class="account-name-input">
                          <button class="btn-icon btn-save" (click)="saveAccountName(account.accountId)" title="Save">✓</button>
                          <button class="btn-icon btn-cancel" (click)="cancelEditingAccountName()" title="Cancel">×</button>
                        </div>
                      } @else {
                        <div class="account-name-container">
                          <div class="account-name">{{ account.name }}</div>
                          <button class="btn-icon btn-edit" (click)="startEditingAccountName(account)" title="Edit name">✎</button>
                        </div>
                      }
                      <div class="account-meta">
                        <span class="account-type">{{ getAccountTypeLabel(account) }}</span>
                        @if (account.mask) {
                          <span class="account-mask">•••• {{ account.mask }}</span>
                        }
                        @if (account.institutionName) {
                          <span class="account-institution">{{ account.institutionName }}</span>
                        }
                      </div>
                    </div>
                    <div class="account-balance positive">
                      +{{ formatCurrency(account.balance) }}
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Liabilities Section -->
          @if (getLiabilityAccounts().length > 0) {
            <div class="account-section">
              <h3 class="section-title">Liabilities</h3>
              <div class="account-list">
                @for (account of getLiabilityAccounts(); track account.accountId) {
                  <div class="account-row liability">
                    <div class="account-info">
                      @if (editingAccountId() === account.accountId) {
                        <div class="account-name-edit">
                          <input 
                            type="text" 
                            [(ngModel)]="editingAccountName"
                            (keyup.enter)="saveAccountName(account.accountId)"
                            (keyup.escape)="cancelEditingAccountName()"
                            class="account-name-input">
                          <button class="btn-icon btn-save" (click)="saveAccountName(account.accountId)" title="Save">✓</button>
                          <button class="btn-icon btn-cancel" (click)="cancelEditingAccountName()" title="Cancel">×</button>
                        </div>
                      } @else {
                        <div class="account-name-container">
                          <div class="account-name">{{ account.name }}</div>
                          <button class="btn-icon btn-edit" (click)="startEditingAccountName(account)" title="Edit name">✎</button>
                        </div>
                      }
                      <div class="account-meta">
                        <span class="account-type">{{ getAccountTypeLabel(account) }}</span>
                        @if (account.mask) {
                          <span class="account-mask">•••• {{ account.mask }}</span>
                        }
                        @if (account.institutionName) {
                          <span class="account-institution">{{ account.institutionName }}</span>
                        }
                      </div>
                    </div>
                    <div class="account-balance negative">
                      {{ formatCurrency(account.balance) }}
                    </div>
                  </div>
                }
              </div>
            </div>
          }
          </div>
        }
      </div>
      } @else if (balanceLoading()) {
        <div class="balance-snapshot">
          <p>Loading balance snapshot...</p>
        </div>
      }

      <!-- Budget Summary -->
      @if (loading()) {
        <div class="loading">Loading budget...</div>
      } @else if (error()) {
        <div class="error">{{ error() }}</div>
      } @else if (!budget()) {
        <div class="empty-state">
          <p>No budget yet. Create your first budget to get started!</p>
          <button class="btn-primary" routerLink="/budgets/edit">Create Budget</button>
        </div>
      } @else {
        <div class="budget-summary">
          <div class="budget-details">
            <div class="detail">
              <span class="label">Period:</span>
              <span>{{ formatDate(budget()!.startDate) }} - {{ formatDate(budget()!.endDate) }}</span>
            </div>
            <div class="detail">
              <span class="label">Income:</span>
              <span class="amount">{{ formatCurrency(budget()!.income) }}</span>
            </div>
          </div>
        </div>
      }
    </div>
  }

  @if (activeTab() === 'transactions') {
    <div class="tab-content transactions-tab">
      <!-- Recent Transactions -->
      <div class="transactions-section">
        <h2>Recent Transactions</h2>
        @if (transactionsLoading() && transactions().length === 0) {
          <div class="loading-message">Loading transactions...</div>
        } @else if (transactionsError()) {
          <div class="error-message">{{ transactionsError() }}</div>
        } @else if (transactions().length === 0) {
          <div class="no-transactions">
            <p>No transactions found.</p>
            <p>Click "Sync Transactions" to fetch transactions from your connected accounts.</p>
          </div>
        } @else {
          <div class="transactions-table">
            <table>
              <thead>
                <tr>
                  <th class="col-date">Date</th>
                  <th class="col-account">Account</th>
                  <th class="col-merchant">Merchant</th>
                  <th class="col-amount">Amount</th>
                  <th class="col-categories">Categories</th>
                </tr>
              </thead>
              <tbody>
                @for (transaction of transactions(); track transaction.id) {
                  <tr class="transaction-row" (click)="onTransactionRowClick(transaction)">
                    <td>{{ formatDate(transaction.date) }}</td>
                    <td>
                      <span class="account-name">{{ transaction.accountName || 'Unknown Account' }}</span>
                    </td>
                    <td>{{ transaction.merchantName || transaction.name }}</td>
                    <td [class.negative]="parseAmount(transaction.amount) < 0">
                      {{ formatCurrency(parseAmount(transaction.amount)) }}
                    </td>
                    <td class="categories-cell">
                      <div class="category-rows">
                        @for (cat of transaction.categories; track cat.id; let i = $index) {
                          <div class="category-row">
                            <!-- Empty space for alignment (no button needed) -->
                            <span></span>
                            
                            <!-- Amount (read-only) -->
                            <span class="amount-display">{{ formatCurrency(parseAmount(cat.amount)) }}</span>
                            
                            <!-- Category Dropdown -->
                            <select 
                              class="category-dropdown"
                              [ngModel]="cat.categoryId"
                              [style.background-color]="getCategoryColor(cat.categoryId)"
                              [style.color]="getCategoryTextColor(cat.categoryId)"
                              (ngModelChange)="quickChangeCategory(transaction.id, i, $event === null ? null : +$event, parseAmount(cat.amount))"
                              (click)="$event.stopPropagation()">
                              <option [ngValue]="null">Uncategorized</option>
                              @for (category of categories(); track category.id) {
                                <option [ngValue]="category.id">{{ category.name }}</option>
                              }
                            </select>
                            
                            <!-- Subcategory Dropdown -->
                            @if (cat.categoryId && getSubcategoriesForCategory(cat.categoryId).length > 0) {
                              <select 
                                class="subcategory-dropdown"
                                [ngModel]="cat.subcategoryId"
                                (ngModelChange)="quickChangeSubcategory(transaction.id, i, $event === null ? null : +$event)"
                                (click)="$event.stopPropagation()">
                                <option [ngValue]="null">No subcategory</option>
                                @for (subcat of getSubcategoriesForCategory(cat.categoryId); track subcat.id) {
                                  <option [ngValue]="subcat.id">{{ subcat.name }}</option>
                                }
                              </select>
                            } @else {
                              <span></span>
                            }
                          </div>
                        }
                        @if (transaction.categories.length === 0) {
                          <div class="category-row">
                            <span></span>
                            <span class="amount-display">{{ formatCurrency(parseAmount(transaction.amount)) }}</span>
                            <select 
                              class="category-dropdown"
                              [ngModel]="null"
                              (ngModelChange)="quickChangeCategory(transaction.id, 0, $event === null ? null : +$event, parseAmount(transaction.amount))"
                              (click)="$event.stopPropagation()">
                              <option [ngValue]="null">Uncategorized</option>
                              @for (category of categories(); track category.id) {
                                <option [ngValue]="category.id">{{ category.name }}</option>
                              }
                            </select>
                            <span></span>
                          </div>
                        }
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
            @if (hasMoreTransactions()) {
              <button class="btn-secondary load-more-btn" (click)="loadMoreTransactions()" [disabled]="transactionsLoading()">
                {{ transactionsLoading() ? 'Loading...' : 'Load More' }}
              </button>
            }
          </div>
        }
      </div>
    </div>
  }

  @if (activeTab() === 'analytics') {
    <div class="tab-content analytics-tab">
      <app-budget-analytics [budget]="budget()" [categories]="categories()"></app-budget-analytics>
    </div>
  }

  <!-- Transaction Edit Modal -->
  @if (selectedTransaction()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Edit Transaction</h2>
          <button class="btn-close" (click)="closeModal()">×</button>
        </div>
        
        <div class="modal-body">
          <div class="transaction-details">
            <div class="detail-row">
              <span class="detail-label">Date:</span>
              <span>{{ formatDate(selectedTransaction()!.date) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Merchant:</span>
              <span>{{ selectedTransaction()!.merchantName || selectedTransaction()!.name }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Amount:</span>
              <span [class.negative]="parseAmount(selectedTransaction()!.amount) < 0">
                {{ formatCurrency(parseAmount(selectedTransaction()!.amount)) }}
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Account:</span>
              <span>{{ selectedTransaction()!.accountName || 'Unknown Account' }}</span>
            </div>
          </div>

          <div class="category-section">
            <div class="section-header">
              <h3>Category Assignment</h3>
              @if (splitSplits().length === 1) {
                <button class="btn-link" (click)="toggleSplitMode()">
                  {{ splitMode() ? 'Single Category' : 'Split Transaction' }}
                </button>
              }
            </div>

            @if (!splitMode()) {
              <!-- Single Category Mode -->
              <div class="single-category-form">
                <label>
                  Category:
                  <select 
                    [value]="splitSplits()[0]?.categoryId || null"
                    (change)="onCategoryChangeInModal(0, $any($event.target).value === 'null' ? null : +$any($event.target).value)">
                    <option [value]="null">Select category...</option>
                    @for (category of categories(); track category.id) {
                      <option [value]="category.id">{{ category.name }}</option>
                    }
                  </select>
                </label>
                @if (splitSplits()[0]?.categoryId && hasSubcategories(splitSplits()[0].categoryId)) {
                  <label>
                    Subcategory:
                    <select 
                      [value]="splitSplits()[0]?.subcategoryId || null"
                      (change)="onSubcategoryChangeInModal(0, $any($event.target).value === 'null' ? null : +$any($event.target).value)">
                      <option [value]="null">No subcategory</option>
                      @for (subcat of getSubcategoriesForCategory(splitSplits()[0].categoryId); track subcat.id) {
                        <option [value]="subcat.id">{{ subcat.name }}</option>
                      }
                    </select>
                  </label>
                }
                <button class="btn-primary" (click)="saveSingleCategory()">Save</button>
              </div>
            } @else {
              <!-- Split Mode -->
              <div class="split-form">
                <div class="splits-list">
                  @for (split of splitSplits(); track $index; let i = $index) {
                    <div class="split-row">
                      <button 
                        class="btn-small btn-danger remove-split-btn" 
                        (click)="removeSplit(i)"
                        [disabled]="splitSplits().length <= 1"
                        title="Remove split">
                        ×
                      </button>
                      <input 
                        type="number" 
                        step="0.01"
                        [ngModel]="splitSplits()[i].useRemaining ? calculateRemainingAmountInModal(i).toFixed(2) : splitSplits()[i].amount"
                        (ngModelChange)="onAmountChangeInModal(i, $event)"
                        placeholder="Amount"
                        class="split-amount-input"
                        [readonly]="splitSplits()[i].useRemaining">
                      <select 
                        [value]="splitSplits()[i]?.categoryId || null"
                        (change)="onCategoryChangeInModal(i, $any($event.target).value === 'null' ? null : +$any($event.target).value)"
                        class="split-category-select">
                        <option [value]="null">Select category...</option>
                        @for (category of categories(); track category.id) {
                          <option [value]="category.id">{{ category.name }}</option>
                        }
                      </select>
                      @if (splitSplits()[i]?.categoryId && hasSubcategories(splitSplits()[i].categoryId)) {
                        <select 
                          [value]="splitSplits()[i]?.subcategoryId || null"
                          (change)="onSubcategoryChangeInModal(i, $any($event.target).value === 'null' ? null : +$any($event.target).value)"
                          class="split-subcategory-select">
                          <option [value]="null">No subcategory</option>
                          @for (subcat of getSubcategoriesForCategory(splitSplits()[i].categoryId); track subcat.id) {
                            <option [value]="subcat.id">{{ subcat.name }}</option>
                          }
                        </select>
                      } @else {
                        <span></span>
                      }
                      <label class="use-remaining-checkbox">
                        <input 
                          type="checkbox"
                          [checked]="splitSplits()[i].useRemaining"
                          (change)="toggleUseRemainingInModal(i)">
                        <span>Use remaining</span>
                      </label>
                    </div>
                  }
                </div>
                
                <div class="split-actions">
                  <button class="btn-secondary" (click)="addSplit()">+ Add Split</button>
                  <div class="split-total">
                    <span>Total: {{ formatCurrency(getSplitTotal()) }}</span>
                    <span class="transaction-total">Transaction: {{ formatCurrency(parseAmount(selectedTransaction()!.amount)) }}</span>
                  </div>
                </div>

                @if (getSplitValidationError()) {
                  <div class="validation-error">{{ getSplitValidationError() }}</div>
                }

                <button 
                  class="btn-primary" 
                  (click)="saveSplit()"
                  [disabled]="!!getSplitValidationError()">
                  Save Split
                </button>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>

