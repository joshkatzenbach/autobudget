<div class="budgets-container">
  <header class="header">
    <div class="header-top">
      <h1>{{ budget()?.name || 'My Budget' }}</h1>
      <div class="header-actions">
        <button class="btn-secondary" (click)="logout()">Logout</button>
      </div>
    </div>
    
    <!-- Tab Navigation -->
    <div class="tabs">
      <button 
        class="tab-button" 
        [class.active]="activeTab() === 'summary'"
        (click)="activeTab.set('summary')">
        Summary
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab() === 'transactions'"
        (click)="activeTab.set('transactions')">
        Transactions
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab() === 'analytics'"
        (click)="activeTab.set('analytics')">
        Analytics
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab() === 'edit'"
        (click)="navigateToEditBudget()">
        Edit Budget
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab() === 'test'"
        (click)="activeTab.set('test')">
        Test
      </button>
      <button 
        class="tab-button" 
        (click)="navigateToSlackIntegration()">
        Slack Integration
      </button>
    </div>
  </header>

  <!-- Tab Content -->
  @if (activeTab() === 'summary') {
    <div class="tab-content summary-tab">
      <!-- Connect Account Button -->
      <div class="summary-actions">
        <app-plaid-link></app-plaid-link>
      </div>
      
      <!-- Balance Snapshot -->
      @if (balanceSnapshot()) {
        <div class="balance-snapshot">
      <div class="balance-header">
        <h2>Current Balance</h2>
        <button class="btn-refresh" (click)="loadBalanceSnapshot()" [disabled]="balanceLoading()">
          {{ balanceLoading() ? 'Refreshing...' : 'Refresh' }}
        </button>
      </div>
      <div class="balance-summary">
        <div class="balance-item">
          <span class="balance-label">Net Balance:</span>
          <span class="balance-amount" [class.positive]="getAdjustedNetBalance() >= 0" [class.negative]="getAdjustedNetBalance() < 0">
            {{ formatCurrency(getAdjustedNetBalance()) }}
          </span>
          @if (getUnconnectedSavingsAmount() > 0) {
            <small style="display: block; color: #666; font-size: 12px; margin-top: 4px;">
              (includes {{ formatCurrency(getUnconnectedSavingsAmount()) }} from unconnected accounts)
            </small>
          }
        </div>
        <div class="balance-breakdown">
          <div class="breakdown-item">
            <span class="breakdown-label">Total Assets:</span>
            <span class="breakdown-amount positive">{{ formatCurrency(getAdjustedTotalAssets()) }}</span>
            @if (getUnconnectedSavingsAmount() > 0) {
              <small style="display: block; color: #666; font-size: 12px; margin-top: 4px;">
                (includes {{ formatCurrency(getUnconnectedSavingsAmount()) }} from unconnected accounts)
              </small>
            }
          </div>
          <div class="breakdown-item">
            <span class="breakdown-label">Total Debts:</span>
            <span class="breakdown-amount negative">{{ formatCurrency(balanceSnapshot()!.totalDebts) }}</span>
          </div>
        </div>
      </div>

      <!-- Account Breakdown -->
      @if (balanceSnapshot()!.accounts.length > 0) {
        <div class="account-breakdown">
          <!-- Assets Section -->
          @if (getAssetAccounts().length > 0) {
            <div class="account-section">
              <h3 class="section-title">Assets</h3>
              <div class="account-list">
                @for (account of getAssetAccounts(); track account.accountId) {
                  <div class="account-row asset">
                    <div class="account-info">
                      @if (editingAccountId() === account.accountId) {
                        <div class="account-name-edit">
                          <input 
                            type="text" 
                            [(ngModel)]="editingAccountName"
                            (keyup.enter)="saveAccountName(account.accountId)"
                            (keyup.escape)="cancelEditingAccountName()"
                            class="account-name-input">
                          <button class="btn-icon btn-save" (click)="saveAccountName(account.accountId)" title="Save">✓</button>
                          <button class="btn-icon btn-cancel" (click)="cancelEditingAccountName()" title="Cancel">×</button>
                        </div>
                      } @else {
                        <div class="account-name-container">
                          <div class="account-name">{{ account.name }}</div>
                          <button class="btn-icon btn-edit" (click)="startEditingAccountName(account)" title="Edit name">✎</button>
                        </div>
                      }
                      <div class="account-meta">
                        <span class="account-type">{{ getAccountTypeLabel(account) }}</span>
                        @if (account.mask) {
                          <span class="account-mask">•••• {{ account.mask }}</span>
                        }
                        @if (account.institutionName) {
                          <span class="account-institution">{{ account.institutionName }}</span>
                        }
                        @if (account.accountId.startsWith('unconnected_')) {
                          <span class="account-institution" style="color: #999; font-style: italic;">(Unconnected Account)</span>
                        }
                      </div>
                    </div>
                    <div class="account-balance positive">
                      +{{ formatCurrency(account.balance) }}
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Liabilities Section -->
          @if (getLiabilityAccounts().length > 0) {
            <div class="account-section">
              <h3 class="section-title">Liabilities</h3>
              <div class="account-list">
                @for (account of getLiabilityAccounts(); track account.accountId) {
                  <div class="account-row liability">
                    <div class="account-info">
                      @if (editingAccountId() === account.accountId) {
                        <div class="account-name-edit">
                          <input 
                            type="text" 
                            [(ngModel)]="editingAccountName"
                            (keyup.enter)="saveAccountName(account.accountId)"
                            (keyup.escape)="cancelEditingAccountName()"
                            class="account-name-input">
                          <button class="btn-icon btn-save" (click)="saveAccountName(account.accountId)" title="Save">✓</button>
                          <button class="btn-icon btn-cancel" (click)="cancelEditingAccountName()" title="Cancel">×</button>
                        </div>
                      } @else {
                        <div class="account-name-container">
                          <div class="account-name">{{ account.name }}</div>
                          @if (!account.accountId.startsWith('unconnected_')) {
                            <button class="btn-icon btn-edit" (click)="startEditingAccountName(account)" title="Edit name">✎</button>
                          }
                        </div>
                      }
                      <div class="account-meta">
                        <span class="account-type">{{ getAccountTypeLabel(account) }}</span>
                        @if (account.mask) {
                          <span class="account-mask">•••• {{ account.mask }}</span>
                        }
                        @if (account.institutionName) {
                          <span class="account-institution">{{ account.institutionName }}</span>
                        }
                        @if (account.accountId.startsWith('unconnected_')) {
                          <span class="account-institution" style="color: #999; font-style: italic;">(Unconnected Account)</span>
                        }
                      </div>
                    </div>
                    <div class="account-balance negative">
                      {{ formatCurrency(account.balance) }}
                    </div>
                  </div>
                }
              </div>
            </div>
          }
          </div>
        }
      </div>
      } @else if (balanceLoading()) {
        <div class="balance-snapshot">
          <p>Loading balance snapshot...</p>
        </div>
      }

      <!-- Budget Summary -->
      @if (loading()) {
        <div class="loading">Loading budget...</div>
      } @else if (error()) {
        <div class="error">{{ error() }}</div>
      } @else if (!budget()) {
        <div class="empty-state">
          <p>No budget yet. Create your first budget to get started!</p>
          <button class="btn-primary" routerLink="/budgets/edit">Create Budget</button>
        </div>
      } @else {
        <div class="budget-summary">
          <!-- Money Breakdown -->
          @if (balanceSnapshot()) {
            <div class="money-breakdown">
              <h3>Money Breakdown</h3>
              
              <!-- Total Net Balance -->
              <div class="breakdown-total">
                <span class="total-label">Total Net Balance:</span>
                <span class="total-amount" [class.positive]="getAdjustedNetBalance() >= 0" [class.negative]="getAdjustedNetBalance() < 0">
                  {{ formatCurrency(getAdjustedNetBalance()) }}
                </span>
                @if (getUnconnectedSavingsAmount() > 0) {
                  <small class="breakdown-help-text" style="display: block; margin-top: 4px;">
                    Includes {{ formatCurrency(getUnconnectedSavingsAmount()) }} from unconnected accounts
                  </small>
                }
              </div>

              <!-- Savings Categories -->
              <div class="breakdown-list">
                <h4>Savings Categories</h4>
                @for (savingsCat of getSavingsCategories(); track savingsCat.id) {
                  <div class="breakdown-item">
                    <div class="breakdown-item-header">
                      <span class="color-indicator" [style.background-color]="savingsCat.color || '#667eea'"></span>
                      <span class="breakdown-item-name">{{ savingsCat.name }}</span>
                    </div>
                    <span class="breakdown-item-amount">{{ formatCurrency(getSavingsCategoryAmount(savingsCat)) }}</span>
                  </div>
                }
                @if (getSavingsCategories().length === 0) {
                  <p class="no-savings">No savings categories</p>
                }
              </div>
              
              <!-- Non-Savings Money -->
              <div class="breakdown-list">
                <h4>Available for Spending</h4>
                <div class="breakdown-item highlight">
                  <div class="breakdown-item-header">
                    <span class="breakdown-item-name">Non-Savings Money</span>
                  </div>
                  <span class="breakdown-item-amount">{{ formatCurrency(getNonSavingsMoney()) }}</span>
                </div>
                  <small class="breakdown-help-text">
                    Adjusted Net Balance ({{ formatCurrency(getAdjustedNetBalance()) }}) - Total Savings ({{ formatCurrency(getTotalSavingsAmount()) }})
                  </small>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }

  @if (activeTab() === 'transactions') {
    <div class="tab-content transactions-tab">
      <!-- Sync Transactions Button -->
      <div class="transactions-actions">
        <button class="btn-primary" (click)="syncTransactions()" [disabled]="syncLoading()">
          {{ syncLoading() ? 'Syncing...' : 'Sync Transactions' }}
        </button>
      </div>
      
      <!-- Recent Transactions -->
      <div class="transactions-section">
        <div class="transactions-header">
          <h2>Recent Transactions</h2>
          <div class="filters">
            <div class="review-filter">
              <label>Filter:</label>
              <select [ngModel]="reviewedFilter()" (ngModelChange)="reviewedFilter.set($event); onReviewFilterChange()">
                <option value="all">All</option>
                <option value="reviewed">Reviewed</option>
                <option value="unreviewed">Unreviewed</option>
              </select>
            </div>
            <div class="fixed-filter">
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  [checked]="showHiddenFixed()"
                  (change)="showHiddenFixed.set($any($event.target).checked); onReviewFilterChange()"
                />
                <span>Show Fixed category transactions</span>
              </label>
            </div>
          </div>
        </div>
        @if (transactionsLoading() && transactions().length === 0) {
          <div class="loading-message">Loading transactions...</div>
        } @else if (transactionsError()) {
          <div class="error-message">{{ transactionsError() }}</div>
        } @else if (transactions().length === 0) {
          <div class="no-transactions">
            <p>No transactions found.</p>
            <p>Click "Sync Transactions" above to fetch transactions from your connected accounts.</p>
          </div>
        } @else {
          <div class="transactions-table">
            <table>
              <thead>
                <tr>
                  <th class="col-date">Date</th>
                  <th class="col-account">Account</th>
                  <th class="col-merchant">Merchant</th>
                  <th class="col-amount">Amount</th>
                  <th class="col-categories">Categories</th>
                  <th class="col-reviewed">Reviewed</th>
                </tr>
              </thead>
              <tbody>
                @for (transaction of transactions(); track transaction.id) {
                  <tr class="transaction-row" (click)="onTransactionRowClick(transaction)">
                    <td>{{ formatDate(transaction.date) }}</td>
                    <td>
                      <span class="account-name">{{ transaction.accountName || 'Unknown Account' }}</span>
                    </td>
                    <td>{{ transaction.merchantName || transaction.name }}</td>
                    <td [class.incoming]="isIncomingTransaction(transaction.amount)">
                      {{ formatTransactionAmount(transaction.amount) }}
                    </td>
                    <td class="categories-cell">
                      <div class="category-rows">
                        @for (cat of transaction.categories; track cat.id; let i = $index) {
                          <div class="category-row">
                            <!-- Empty space for alignment (no button needed) -->
                            <span></span>
                            
                            <!-- Amount (read-only) -->
                            <span class="amount-display">{{ formatCurrency(parseAmount(cat.amount)) }}</span>
                            
                            <!-- Category Dropdown -->
                            <select 
                              class="category-dropdown"
                              [ngModel]="cat.categoryId"
                              [style.background-color]="getCategoryColor(cat.categoryId)"
                              [style.color]="getCategoryTextColor(cat.categoryId)"
                              (ngModelChange)="quickChangeCategory(transaction.id, i, $event === null ? null : +$event, parseAmount(cat.amount))"
                              (click)="$event.stopPropagation()">
                              <option [ngValue]="null">Uncategorized</option>
                              @for (category of categories(); track category.id) {
                                <option [ngValue]="category.id">{{ category.name }}</option>
                              }
                            </select>
                          </div>
                        }
                        @if (transaction.categories.length === 0) {
                          <div class="category-row">
                            <span></span>
                            <span class="amount-display">{{ formatCurrency(parseAmount(transaction.amount)) }}</span>
                            <select 
                              class="category-dropdown"
                              [ngModel]="null"
                              (ngModelChange)="quickChangeCategory(transaction.id, 0, $event === null ? null : +$event, parseAmount(transaction.amount))"
                              (click)="$event.stopPropagation()">
                              <option [ngValue]="null">Uncategorized</option>
                              @for (category of categories(); track category.id) {
                                <option [ngValue]="category.id">{{ category.name }}</option>
                              }
                            </select>
                            <span></span>
                          </div>
                        }
                      </div>
                    </td>
                    <td class="col-status">
                      @if (transaction.isReviewed) {
                        <span class="review-icon reviewed">✓</span>
                      } @else {
                        <span class="review-icon unreviewed"></span>
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
            @if (hasMoreTransactions()) {
              <button class="btn-secondary load-more-btn" (click)="loadMoreTransactions()" [disabled]="transactionsLoading()">
                {{ transactionsLoading() ? 'Loading...' : 'Load More' }}
              </button>
            }
          </div>
        }
      </div>
    </div>
  }


  @if (activeTab() === 'analytics') {
    <div class="tab-content analytics-tab">
      <app-budget-analytics [budget]="budget()" [categories]="categories()"></app-budget-analytics>
    </div>
  }

  @if (activeTab() === 'test') {
    <div class="tab-content test-tab">
      <div class="test-card">
        <h2>Test Transaction Generator</h2>
        <p class="test-description">
          This tool simulates a Plaid webhook by creating a test transaction, categorizing it with OpenAI, and sending a Slack notification.
          Use this to test the complete transaction processing flow without waiting for real Plaid webhooks.
        </p>
        
        @if (testTransactionError()) {
          <div class="alert alert-error">
            {{ testTransactionError() }}
          </div>
        }
        
        @if (testTransactionSuccess()) {
          <div class="alert alert-success">
            {{ testTransactionSuccess() }}
          </div>
        }
        
        <button 
          class="btn-primary" 
          (click)="generateTestTransaction()"
          [disabled]="generatingTestTransaction()">
          {{ generatingTestTransaction() ? 'Generating...' : 'Generate Transaction' }}
        </button>
      </div>
    </div>
  }

  <!-- Transaction Edit Modal -->
  @if (selectedTransaction()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Edit Transaction</h2>
          <button class="btn-close" (click)="closeModal()">×</button>
        </div>
        
        <div class="modal-body">
          <div class="transaction-details">
            <div class="detail-row">
              <span class="detail-label">Date:</span>
              <span>{{ formatDate(selectedTransaction()!.date) }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Merchant:</span>
              <span>{{ selectedTransaction()!.merchantName || selectedTransaction()!.name }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Amount:</span>
              <span [class.incoming]="isIncomingTransaction(selectedTransaction()!.amount)">
                {{ formatTransactionAmount(selectedTransaction()!.amount) }}
              </span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Account:</span>
              <span>{{ selectedTransaction()!.accountName || 'Unknown Account' }}</span>
            </div>
          </div>

          <div class="category-section">
            <div class="section-header">
              <h3>Category Assignment</h3>
              @if (splitSplits().length === 1) {
                <button class="btn-link" (click)="toggleSplitMode()">
                  {{ splitMode() ? 'Single Category' : 'Split Transaction' }}
                </button>
              }
            </div>

            @if (!splitMode()) {
              <!-- Single Category Mode -->
              <div class="single-category-form">
                <label>
                  Category:
                  <select 
                    [ngModel]="splitSplits()[0]?.categoryId || null"
                    (ngModelChange)="onCategoryChangeInModal(0, $event === null ? null : +$event)">
                    <option [ngValue]="null">Select category...</option>
                    @for (category of categories(); track category.id) {
                      <option [ngValue]="category.id">{{ category.name }}</option>
                    }
                  </select>
                </label>
                <button class="btn-primary" (click)="saveSingleCategory()">Save</button>
              </div>
            } @else {
              <!-- Split Mode -->
              <div class="split-form">
                <div class="splits-list">
                  @for (split of splitSplits(); track $index; let i = $index) {
                    @let isLastSplit = i === splitSplits().length - 1;
                    <div class="split-row">
                      <button 
                        class="btn-small btn-danger remove-split-btn" 
                        (click)="removeSplit(i)"
                        [disabled]="splitSplits().length <= 1"
                        title="Remove split">
                        ×
                      </button>
                      <input 
                        type="number" 
                        step="0.01"
                        [ngModel]="isLastSplit ? calculateRemainingAmountInModal(i).toFixed(2) : splitSplits()[i].amount"
                        (ngModelChange)="onAmountChangeInModal(i, $event)"
                        placeholder="Amount"
                        class="split-amount-input"
                        [readonly]="isLastSplit"
                        [title]="isLastSplit ? 'The rest of the money will be used for this split' : ''">
                      <select 
                        [ngModel]="splitSplits()[i]?.categoryId || null"
                        (ngModelChange)="onCategoryChangeInModal(i, $event === null ? null : +$event)"
                        class="split-category-select">
                        <option [ngValue]="null">Select category...</option>
                        @for (category of categories(); track category.id) {
                          <option [ngValue]="category.id">{{ category.name }}</option>
                        }
                      </select>
                      @if (isLastSplit) {
                        <span class="use-remaining-label">Uses remaining</span>
                      }
                    </div>
                  }
                </div>
                
                <div class="split-actions">
                  <button class="btn-secondary" (click)="addSplit()">+ Add Split</button>
                  <div class="split-total">
                    <span>Total: {{ formatCurrency(getSplitTotal()) }}</span>
                    <span class="transaction-total">Transaction: {{ formatCurrency(parseAmount(selectedTransaction()!.amount)) }}</span>
                  </div>
                </div>

                @if (getSplitValidationError()) {
                  <div class="validation-error">{{ getSplitValidationError() }}</div>
                }

                <button 
                  class="btn-primary" 
                  (click)="saveSplit()"
                  [disabled]="!!getSplitValidationError()">
                  Save Split
                </button>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>

