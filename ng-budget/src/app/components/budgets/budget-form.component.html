<div class="budget-form-container">
  <div class="budget-form-card">
    <header class="form-header">
      <h1>{{ isEditMode() ? 'Edit Budget' : 'Create New Budget' }}</h1>
      <button class="btn-close" (click)="cancel()">×</button>
    </header>

    @if (error()) {
      <div class="error-message">{{ error() }}</div>
    }

    <form (ngSubmit)="onSubmit()" #form="ngForm">
      <div class="two-pane-layout">
        <!-- Left Pane: User Input -->
        <div class="left-pane">
          <!-- Budget Basic Info -->
          <section class="form-section">
            <h2>Budget Information</h2>
            
            <div class="form-group">
              <label for="name">
                Budget Name *
                <span class="info-icon" title="A descriptive name for your budget (e.g., 'January 2024 Budget')">ℹ️</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                [(ngModel)]="budgetForm.name"
                required
                placeholder="e.g., January 2024 Budget"
                [disabled]="loading()"
              />
            </div>

            <div class="form-group">
              <label for="income">
                Income *
                <span class="info-icon" title="Your total monthly or annual income before taxes. This is used to calculate your available budget after taxes.">ℹ️</span>
              </label>
              <div class="income-input-group">
                <input
                  type="number"
                  id="income"
                  name="income"
                  [ngModel]="budgetForm.income()"
                  (ngModelChange)="budgetForm.income.set($event); initializeSurplusCategory()"
                  required
                  step="0.01"
                  min="0"
                  placeholder="0.00"
                  [disabled]="loading()"
                />
                <select 
                  [ngModel]="budgetForm.incomePeriod()"
                  (ngModelChange)="budgetForm.incomePeriod.set($event); initializeSurplusCategory()"
                  name="incomePeriod"
                  [disabled]="loading()"
                >
                  <option value="monthly">Monthly</option>
                  <option value="annual">Annual</option>
                </select>
              </div>
            </div>
          </section>

          <!-- Tax Information -->
          <section class="form-section">
            <div class="tax-section-header">
              <h2>Tax Information</h2>
              <button type="button" class="btn-reset" (click)="resetTaxDefaults()" [disabled]="loading()">
                Reset to Defaults
              </button>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="filingStatus">
                  Filing Status *
                  <span class="info-icon" title="Your tax filing status determines your standard deduction and tax brackets. Choose the status you use when filing your federal taxes.">ℹ️</span>
                </label>
                <select
                  id="filingStatus"
                  name="filingStatus"
                  [ngModel]="budgetForm.filingStatus()"
                  (ngModelChange)="budgetForm.filingStatus.set($event)"
                  required
                  [disabled]="loading()"
                >
                  <option value="single">Single</option>
                  <option value="married-jointly">Married Filing Jointly</option>
                  <option value="married-separately">Married Filing Separately</option>
                  <option value="head-of-household">Head of Household</option>
                </select>
              </div>

              <div class="form-group">
                <label for="deductions">
                  Additional Deductions ($)
                  <span class="info-icon" title="Any deductions beyond the standard deduction (e.g., itemized deductions, student loan interest, HSA contributions). This is added to your standard deduction to reduce taxable income.">ℹ️</span>
                </label>
                <input
                  type="number"
                  id="deductions"
                  name="deductions"
                  [ngModel]="budgetForm.deductions()"
                  (ngModelChange)="budgetForm.deductions.set($event)"
                  step="0.01"
                  min="0"
                  placeholder="0.00"
                  [disabled]="loading()"
                />
                <small class="help-text">Beyond standard deduction ({{ formatCurrency(getStandardDeduction()) }})</small>
              </div>
            </div>
          </section>

          <!-- Spending Categories -->
          <section class="form-section">
            <div class="section-header">
              <h2>Spending Categories</h2>
            </div>

            @if (categories().length === 0) {
              <div class="empty-categories">
                <p>No categories yet. Click "Add Category" to get started.</p>
              </div>
            } @else {
              <div class="categories-list">
                @for (category of categories(); track $index; let categoryIndex = $index) {
                  <div class="category-item">
                    <div class="category-summary" (click)="expandedCategoryIndex.set(expandedCategoryIndex() === categoryIndex ? null : categoryIndex)">
                      <span class="category-name">{{ category.name || 'New Category' }}</span>
                      <span class="category-amount">{{ formatCurrency(getCategoryAmount(category.allocatedAmount)) }}</span>
                      @if (category.categoryType !== 'surplus') {
                        <button type="button" class="btn-remove" (click)="removeCategory(categoryIndex); $event.stopPropagation()" [disabled]="loading()">Remove</button>
                      }
                    </div>

                    @if (expandedCategoryIndex() === categoryIndex) {
                      <div class="category-form-expanded">
                        @if (category.categoryType === 'surplus') {
                          <!-- Surplus category - only color is editable -->
                          <div class="form-group">
                            <label>Category Name</label>
                            <input type="text" [value]="category.name" disabled />
                            <small class="help-text">Surplus category is automatically calculated</small>
                          </div>

                          <div class="form-group">
                            <label>Allocated Amount</label>
                            <input type="text" [value]="formatCurrency(getCategoryAmount(category.allocatedAmount))" disabled />
                            <small class="help-text">This is automatically set to your remaining budget</small>
                          </div>

                          <div class="form-group">
                            <label>Color</label>
                            <input 
                              type="color" 
                              [(ngModel)]="category.color" 
                              name="catColor{{$index}}"
                              [value]="category.color || '#28a745'"
                              [disabled]="loading()"
                              class="color-picker"
                            />
                          </div>
                        } @else {
                          <!-- Regular category - fully editable -->
                          <div class="form-group">
                            <label>
                              Category Name *
                              <span class="info-icon" title="A descriptive name for this budget category (e.g., 'Groceries', 'Rent', 'Emergency Fund')">ℹ️</span>
                            </label>
                            <input type="text" [(ngModel)]="category.name" name="catName{{$index}}" required [disabled]="loading()" />
                          </div>

                          <div class="form-group">
                            <label>
                              Category Type *
                              <span class="info-icon" title="Fixed: For bills with consistent amounts (e.g., rent, utilities). Variable: For flexible spending (e.g., groceries, entertainment). Savings: For money you're setting aside (e.g., emergency fund, retirement).">ℹ️</span>
                            </label>
                            <select [(ngModel)]="category.categoryType" name="catType{{$index}}" [disabled]="loading()">
                              <option value="fixed">Fixed</option>
                              <option value="savings">Savings</option>
                              <option value="variable">Variable</option>
                            </select>
                          </div>

                          <!-- Amount input -->
                          <div class="form-group">
                            <label>
                              Amount ($) *
                              <span class="info-icon" title="The amount you plan to spend (for Fixed/Variable) or save (for Savings) per month or per year. Choose monthly or annual based on how you think about this category.">ℹ️</span>
                            </label>
                            <div class="amount-input-group">
                              <input type="number" [(ngModel)]="category.allocatedAmount" name="catAmount{{$index}}" step="0.01" min="0" required [disabled]="loading()" />
                              <select [(ngModel)]="category.allocatedAmountPeriod" [name]="'catAmountPeriod' + $index" [disabled]="loading()">
                                <option value="monthly">Monthly</option>
                                <option value="annual">Annual</option>
                              </select>
                            </div>
                            <small class="help-text">
                              @if (category.categoryType === 'savings') {
                                Amount to allocate/save
                              } @else {
                                Expected amount to spend
                              }
                            </small>
                          </div>

                          <div class="form-group">
                            <label>Color</label>
                            <input 
                              type="color" 
                              [(ngModel)]="category.color" 
                              name="catColor{{$index}}"
                              [value]="category.color || getNextAvailableColor()"
                              [disabled]="loading()"
                              class="color-picker"
                            />
                          </div>

                        <!-- Savings Category Fields -->
                        @if (category.categoryType === 'savings') {
                          <div class="category-settings-section">
                            <h4>Savings Settings</h4>
                            
                            <div class="form-group">
                              <label>
                                Accumulated Total ($)
                                <span class="info-icon" title="The current total amount saved in this category year-to-date. This is the starting balance for tracking your savings progress.">ℹ️</span>
                              </label>
                              <input 
                                type="number" 
                                [ngModel]="parseAmount(category.accumulatedTotal || '0')" 
                                (ngModelChange)="category.accumulatedTotal = ($event !== null && $event !== undefined) ? $event.toString() : '0'"
                                name="catAccum{{$index}}" 
                                step="0.01" 
                                min="0" 
                                [disabled]="loading()" 
                              />
                              <small class="help-text">Current total saved in this category (year-to-date)</small>
                            </div>

                            <div class="form-group">
                              <label class="checkbox-label">
                                <input 
                                  type="checkbox" 
                                  [(ngModel)]="category.isTaxDeductible" 
                                  name="catTaxDeductible{{$index}}"
                                  [disabled]="loading()"
                                />
                                <span>
                                  This savings is tax-deductible
                                  <span class="info-icon" title="Check this if your savings contributions reduce your taxable income (e.g., Traditional 401k, Traditional IRA, HSA). This will lower your income tax calculations.">ℹ️</span>
                                </span>
                              </label>
                              <small class="help-text">Check if this savings reduces your taxable income (e.g., 401k, Traditional IRA)</small>
                            </div>

                            @if (category.isTaxDeductible) {
                              <div class="form-group">
                                <label class="checkbox-label">
                                  <input 
                                    type="checkbox" 
                                    [(ngModel)]="category.isSubjectToFica" 
                                    name="catSubjectToFica{{$index}}"
                                    [disabled]="loading()"
                                  />
                                  <span>
                                    Subject to FICA taxes
                                    <span class="info-icon" title="Most tax-deductible savings (like 401k) are subject to FICA taxes. Some (like HSA through payroll deduction) may not be. Check your employer's setup.">ℹ️</span>
                                  </span>
                                </label>
                                <small class="help-text">Check if FICA taxes (Social Security and Medicare) apply to this tax-deductible savings</small>
                              </div>
                            }

                            <div class="form-group">
                              <label class="checkbox-label">
                                <input 
                                  type="checkbox" 
                                  [(ngModel)]="category.isUnconnectedAccount" 
                                  name="catUnconnectedAccount{{$index}}"
                                  [disabled]="loading()"
                                />
                                <span>
                                  This money is stored in an account that is not currently connected
                                  <span class="info-icon" title="Check this if this savings account is not connected via Plaid. The amount will be added to your total assets on the summary page.">ℹ️</span>
                                </span>
                              </label>
                              <small class="help-text">If checked, this amount will be added to your assets on the summary page</small>
                            </div>
                          </div>
                        }

                        <!-- Variable Category Fields -->
                        @if (category.categoryType === 'variable') {
                          <div class="category-settings-section">
                            <h4>Month-End Settings</h4>
                            
                            <div class="form-group">
                              <label class="checkbox-label">
                                <input 
                                  type="checkbox" 
                                  [(ngModel)]="category.autoMoveSurplus" 
                                  name="catAutoMoveSurplus{{$index}}"
                                  [disabled]="loading()"
                                />
                                <span>
                                  Auto-move surplus at month end
                                  <span class="info-icon" title="If enabled, any money left over in this category at the end of the month will automatically be moved to the selected savings category. If disabled, you'll be prompted via Slack to choose where to move it.">ℹ️</span>
                                </span>
                              </label>
                              @if (category.autoMoveSurplus) {
                                <select 
                                  [(ngModel)]="category.surplusTargetCategoryId" 
                                  name="catSurplusTarget{{$index}}"
                                  [disabled]="loading()"
                                  class="category-select">
                                  <option [ngValue]="null">Select savings category...</option>
                                  @for (savingsCat of getSavingsCategories(); track savingsCat.id) {
                                    <option [ngValue]="savingsCat.id">{{ savingsCat.name }}</option>
                                  }
                                </select>
                              }
                            </div>

                            <div class="form-group">
                              <label class="checkbox-label">
                                <input 
                                  type="checkbox" 
                                  [(ngModel)]="category.autoMoveDeficit" 
                                  name="catAutoMoveDeficit{{$index}}"
                                  [disabled]="loading()"
                                />
                                <span>
                                  Auto-move deficit at month end
                                  <span class="info-icon" title="If enabled, if you overspend in this category, money will automatically be taken from the selected savings category to cover the deficit. If disabled, you'll be prompted via Slack to choose where to take it from.">ℹ️</span>
                                </span>
                              </label>
                              @if (category.autoMoveDeficit) {
                                <select 
                                  [(ngModel)]="category.deficitSourceCategoryId" 
                                  name="catDeficitSource{{$index}}"
                                  [disabled]="loading()"
                                  class="category-select">
                                  <option [ngValue]="null">Select savings category...</option>
                                  @for (savingsCat of getSavingsCategories(); track savingsCat.id) {
                                    <option [ngValue]="savingsCat.id">{{ savingsCat.name }}</option>
                                  }
                                </select>
                              }
                            </div>
                          </div>
                        }

                        <!-- Fixed Category Fields -->
                        @if (category.categoryType === 'fixed') {
                          <div class="category-settings-section">
                            <h4>Bill Settings</h4>
                            
                            <div class="form-group">
                              <label>
                                Expected Merchant Name
                                <span class="info-icon" title="The name of the merchant/business for bills in this category. This helps the AI automatically categorize transactions from this merchant to this category.">ℹ️</span>
                              </label>
                              <div class="merchant-search-group">
                                <input 
                                  type="text" 
                                  [(ngModel)]="category.expectedMerchantName" 
                                  name="catMerchant{{$index}}"
                                  [disabled]="loading()"
                                  placeholder="Search or enter merchant name..."
                                  (focus)="showMerchantSuggestions(categoryIndex)"
                                  (blur)="hideMerchantSuggestions(categoryIndex)"
                                  class="merchant-input"
                                />
                                <button 
                                  type="button" 
                                  class="btn-small btn-secondary"
                                  (click)="openMerchantSearch(categoryIndex)"
                                  [disabled]="loading()">
                                  Search
                                </button>
                              </div>
                              <small class="help-text">Used to help AI categorize transactions from this merchant</small>
                              @if (merchantSuggestionsVisible()[categoryIndex] && merchantSuggestions()[categoryIndex] && merchantSuggestions()[categoryIndex]!.length > 0) {
                                <div class="merchant-suggestions">
                                  @for (merchant of merchantSuggestions()[categoryIndex]!; track merchant) {
                                    <div 
                                      class="merchant-suggestion-item"
                                      (click)="selectMerchant(categoryIndex, merchant)">
                                      {{ merchant }}
                                    </div>
                                  }
                                </div>
                              }
                            </div>

                            <div class="form-group">
                              <label class="checkbox-label">
                                <input 
                                  type="checkbox" 
                                  [(ngModel)]="category.hideFromTransactionLists" 
                                  name="catHideFromLists{{$index}}"
                                  [disabled]="loading()"
                                />
                                <span>
                                  Hide from transaction lists
                                  <span class="info-icon" title="When checked, transactions in this category won't appear in the main transaction list or Slack notifications. Useful for recurring bills you don't need to review.">ℹ️</span>
                                </span>
                              </label>
                              <small class="help-text">Hide transactions in this category from the main transaction list and Slack notifications</small>
                            </div>
                          </div>
                        }

                          <div class="category-form-actions">
                            <div class="save-category-wrapper">
                              <button 
                                type="button" 
                                class="btn-primary" 
                                (click)="$event.preventDefault(); $event.stopPropagation(); saveCategory(categoryIndex)" 
                                [disabled]="loading()"
                              >
                                Save Category
                              </button>
                              @if (getCategoryError(categoryIndex)) {
                                <div class="category-error-message">{{ getCategoryError(categoryIndex) }}</div>
                              }
                            </div>
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            }

            <button type="button" class="btn-add" (click)="expandCategoryForm()" [disabled]="loading()">
              + Add Category
            </button>
          </section>

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="cancel()" [disabled]="loading()">Cancel</button>
            <button type="submit" class="btn-primary" [disabled]="loading() || !form.valid">
              {{ loading() ? (isEditMode() ? 'Updating...' : 'Creating...') : (isEditMode() ? 'Update Budget' : 'Create Budget') }}
            </button>
          </div>
        </div>

        <!-- Right Pane: Summary -->
        <div class="right-pane">
          <!-- Tax Summary -->
          <section class="summary-section">
            <h3>Tax Summary</h3>
            <div class="summary-table">
              <div class="summary-header">
                <span></span>
                <span>Monthly</span>
                <span>Annual</span>
              </div>
              <div class="summary-row">
                <span>Federal Income Tax</span>
                <span class="summary-amount">{{ formatCurrency(getFederalIncomeTaxAmount()) }}</span>
                <span class="summary-amount">{{ formatCurrency(taxCalculation().federalIncomeTax.amount) }}</span>
              </div>
              <div class="summary-row">
                <span>FICA Taxes</span>
                <span class="summary-amount">{{ formatCurrency(getFicaTaxAmount()) }}</span>
                <span class="summary-amount">{{ formatCurrency(taxCalculation().ficaTax.total.amount) }}</span>
              </div>
              <div class="summary-row">
                <span>State Tax</span>
                <span class="summary-amount">{{ formatCurrency(getStateTaxAmount()) }}</span>
                <span class="summary-amount">{{ formatCurrency(taxCalculation().stateTax.amount) }}</span>
              </div>
              <div class="summary-row highlight">
                <span><strong>Total Tax</strong></span>
                <span class="summary-amount"><strong>{{ formatCurrency(getTaxAmount()) }}</strong></span>
                <span class="summary-amount"><strong>{{ formatCurrency(getAnnualTaxAmount()) }}</strong></span>
              </div>
            </div>
          </section>

          <!-- Budget Summary -->
          <section class="summary-section">
            <h3>Budget Summary</h3>
            <div class="summary-table">
              <div class="summary-header">
                <span></span>
                <span>Monthly</span>
                <span>Yearly</span>
              </div>
              
              <!-- Total Income -->
              <div class="summary-row">
                <span>Total Income</span>
                <span class="summary-amount">{{ formatCurrency(getIncomeAmount()) }}</span>
                <span class="summary-amount">{{ formatCurrency(getAnnualIncome()) }}</span>
              </div>

              <!-- Spending Categories - each on its own line -->
              @for (item of getAnnualSpendingSummary(); track item.name) {
                <div class="summary-row spending-category">
                  <span class="category-name">
                    <span class="color-indicator" [style.background-color]="item.color"></span>
                    {{ item.name }}
                  </span>
                  <span class="summary-amount">{{ formatCurrency(item.monthly) }}</span>
                  <span class="summary-amount">{{ formatCurrency(item.annual) }}</span>
                </div>
              }

              <!-- Total Spending -->
              <div class="summary-row highlight">
                <span><strong>Total Spending</strong></span>
                <span class="summary-amount"><strong>{{ formatCurrency(getTotalSpending()) }}</strong></span>
                <span class="summary-amount"><strong>{{ formatCurrency(getAnnualTotalSpending()) }}</strong></span>
              </div>

              <!-- Remaining Budget (Surplus) -->
              <div class="summary-row highlight remaining-budget" [class.negative]="getRemainingBudget() < 0">
                <span class="category-name">
                  <span class="color-indicator" style="background-color: #28a745"></span>
                  <strong>Surplus (Remaining Budget)</strong>
                </span>
                <span class="summary-amount"><strong>{{ formatCurrency(getRemainingBudget()) }}</strong></span>
                <span class="summary-amount"><strong>{{ formatCurrency(getAnnualRemainingBudget()) }}</strong></span>
              </div>
            </div>
          </section>
        </div>
      </div>

    </form>
  </div>
</div>
